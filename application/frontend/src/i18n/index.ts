export type Messages = Record<string, string>;

const uz: Messages = {
  appTitle: "LinguaText",
  folders: "Jildlar",
  yourFolders: "Jildlaringiz",
  newFolder: "Yangi jild",
  newFolderPlaceholder: "Jild nomi",
  createIn: "Yaratiladigan joy: {place}",
  root: "Ildiz",
  back: "Orqaga",
  loadingFolders: "Jildlar yuklanmoqda…",
  noFoldersYet: "Hozircha jildlar yo‘q",
  nameLabel: "Nomi",
  nameHelper: "1–100 ta belgi",
  nameExists: "Bunday nom allaqachon mavjud",
  cancel: "Bekor qilish",
  create: "Yaratish",
  folderCreated: "Jild yaratildi",
  unauthorized: "Ruxsat yo‘q",
  loginWithTelegram: "Telegram orqali kirish",
  loggingIn: "Kirish…",
  loggedInAs: "Kirish holati:",
  helloTitle: "Assalomu alaykum, Tillar o‘rganish ilovasi",
  environmentTWA: "Muhit: Telegram WebApp ✅",
  andHelloName: "— Salom, {name}!",
  errorLoadFolders: "Jildlarni yuklab bo‘lmadi",
  errorCreateFolder: "Jild yaratishda xatolik",
  // Texts
  addText: "Matn qo‘shish",
  titleLabel: "Sarlavha",
  uzRawLabel: "Matn",
  enRawLabel: "Matn",
  createText: "Matnni yaratish",
  textCreated: "Matn yaratildi",
  prev: "Oldingi",
  next: "Keyingi",
  ofTotal: "{i} / {n}",
  // Build mode
  buildTitle: "Gapni tuzing",
  check: "Tekshirish",
  correct: "To‘g‘ri!",
  incorrect: "Noto‘g‘ri, yana urinib ko‘ring",
  reset: "Qayta",
  reveal: "Ko‘rsatish",
  continue: "Davom etish",
  correctAnswer: "To‘g‘ri javob:",
  // Common/missing
  loading: "Yuklanmoqda…",
  noSentences: "Gaplar yo‘q",
  editText: "Matnni tahrirlash",
  save: "Saqlash",
  pleaseFillAllFieldsCorrectly:
    "Iltimos, barcha maydonlarni to‘g‘ri to‘ldiring",
  saved: "Saqlandi",
  textUpdated: "Matn yangilandi",
  folderRenamed: "Jild nomi o‘zgartirildi",
  delete: "O‘chirish",
  rename: "Nomini o‘zgartirish",
  edit: "Tahrirlash",
  confirmDeleteFolder: "Ushbu jild va uning tarkibini o‘chirilsinmi?",
  confirmDeleteText: "Ushbu matn o‘chirilsinmi?",
  texts: "Matnlar",
  noTextsYet: "Bu jilda hali matn yo‘q",
  failed: "Xatolik",
  failedOpenEditor: "Muharrirni ochib bo‘lmadi",
  tapWordsBelow: "Quyidagi so‘zlarni bosing",
};

const en: Messages = {
  appTitle: "LinguaText",
  folders: "Folders",
  yourFolders: "Your folders",
  newFolder: "New Folder",
  newFolderPlaceholder: "Folder name",
  createIn: "Create in: {place}",
  root: "Root",
  back: "Back",
  loadingFolders: "Loading folders…",
  noFoldersYet: "No folders yet",
  nameLabel: "Name",
  nameHelper: "1–100 characters",
  nameExists: "Name already exists",
  cancel: "Cancel",
  create: "Create",
  folderCreated: "Folder created",
  unauthorized: "Unauthorized",
  loginWithTelegram: "Login with Telegram",
  loggingIn: "Logging in…",
  loggedInAs: "Logged in as:",
  helloTitle: "Hello, Languages Learning App",
  environmentTWA: "Environment: Telegram WebApp ✅",
  andHelloName: "— Hello, {name}!",
  errorLoadFolders: "Failed to load folders",
  errorCreateFolder: "Failed to create folder",
  // Texts
  addText: "Add Text",
  titleLabel: "Title",
  uzRawLabel: "Text",
  enRawLabel: "Text",
  createText: "Text",
  textCreated: "Text created",
  prev: "Prev",
  next: "Next",
  ofTotal: "{i} / {n}",
  // Build mode
  buildTitle: "Build the sentence",
  check: "Check",
  correct: "Correct!",
  incorrect: "Incorrect, try again",
  reset: "Reset",
  reveal: "Reveal",
  continue: "Continue",
  correctAnswer: "Correct answer:",
  // Common/missing
  loading: "Loading…",
  noSentences: "No sentences",
  editText: "Edit text",
  save: "Save",
  pleaseFillAllFieldsCorrectly: "Please fill all fields correctly",
  saved: "Saved",
  textUpdated: "Text updated",
  folderRenamed: "Folder renamed",
  delete: "Delete",
  rename: "Rename",
  edit: "Edit",
  confirmDeleteFolder: "Delete this folder and its contents?",
  confirmDeleteText: "Delete this text?",
  texts: "Texts",
  noTextsYet: "No texts in this folder yet",
  failed: "Failed",
  failedOpenEditor: "Failed to open editor",
  tapWordsBelow: "Tap words below",
};

const ru: Messages = {
  appTitle: "LinguaText",
  folders: "Папки",
  yourFolders: "Ваши папки",
  newFolder: "Новая папка",
  newFolderPlaceholder: "Название папки",
  createIn: "Создать в: {place}",
  root: "Корень",
  back: "Назад",
  loadingFolders: "Загрузка папок…",
  noFoldersYet: "Папок пока нет",
  nameLabel: "Название",
  nameHelper: "1–100 символов",
  nameExists: "Такое имя уже существует",
  cancel: "Отмена",
  create: "Создать",
  folderCreated: "Папка создана",
  unauthorized: "Нет доступа",
  loginWithTelegram: "Войти через Telegram",
  loggingIn: "Входим…",
  loggedInAs: "Вошли как:",
  helloTitle: "Здравствуйте, приложение для изучения языков",
  environmentTWA: "Среда: Telegram WebApp ✅",
  andHelloName: "— Привет, {name}!",
  errorLoadFolders: "Не удалось загрузить папки",
  errorCreateFolder: "Не удалось создать папку",
  addText: "Добавить текст",
  titleLabel: "Заголовок",
  uzRawLabel: "Текст",
  enRawLabel: "Текст",
  createText: "Создать текст",
  textCreated: "Текст создан",
  prev: "Назад",
  next: "Далее",
  ofTotal: "{i} / {n}",
  buildTitle: "Соберите предложение",
  check: "Проверить",
  correct: "Верно!",
  incorrect: "Неверно, попробуйте снова",
  reset: "Сброс",
  reveal: "Показать",
  continue: "Продолжить",
  correctAnswer: "Правильный ответ:",
  // Common/missing
  loading: "Загрузка…",
  noSentences: "Нет предложений",
  editText: "Редактировать текст",
  save: "Сохранить",
  pleaseFillAllFieldsCorrectly: "Заполните все поля корректно",
  saved: "Сохранено",
  textUpdated: "Текст обновлён",
  folderRenamed: "Папка переименована",
  delete: "Удалить",
  rename: "Переименовать",
  edit: "Редактировать",
  confirmDeleteFolder: "Удалить эту папку и её содержимое?",
  confirmDeleteText: "Удалить этот текст?",
  texts: "Тексты",
  noTextsYet: "В этой папке пока нет текстов",
  failed: "Ошибка",
  failedOpenEditor: "Не удалось открыть редактор",
  tapWordsBelow: "Нажмите на слова ниже",
};

const ko: Messages = {
  appTitle: "LinguaText",
  folders: "폴더",
  yourFolders: "내 폴더",
  newFolder: "새 폴더",
  newFolderPlaceholder: "폴더 이름",
  createIn: "생성 위치: {place}",
  root: "루트",
  back: "뒤로",
  loadingFolders: "폴더 로딩 중…",
  noFoldersYet: "아직 폴더가 없습니다",
  nameLabel: "이름",
  nameHelper: "1–100자",
  nameExists: "이미 존재하는 이름입니다",
  cancel: "취소",
  create: "생성",
  folderCreated: "폴더가 생성되었습니다",
  unauthorized: "권한 없음",
  loginWithTelegram: "Telegram으로 로그인",
  loggingIn: "로그인 중…",
  loggedInAs: "로그인됨:",
  helloTitle: "안녕하세요, 언어 학습 앱입니다",
  environmentTWA: "환경: Telegram WebApp ✅",
  andHelloName: "— 안녕하세요, {name}님!",
  errorLoadFolders: "폴더를 불러오지 못했습니다",
  errorCreateFolder: "폴더 생성에 실패했습니다",
  addText: "텍스트 추가",
  titleLabel: "제목",
  uzRawLabel: "우즈베크어 텍스트",
  enRawLabel: "영어 텍스트",
  createText: "텍스트 만들기",
  textCreated: "텍스트가 생성되었습니다",
  prev: "이전",
  next: "다음",
  ofTotal: "{i} / {n}",
  buildTitle: "문장을 구성하세요",
  check: "확인",
  correct: "정답!",
  incorrect: "오답입니다. 다시 시도하세요",
  reset: "초기화",
  reveal: "정답 보기",
  continue: "계속",
  correctAnswer: "정답:",
  // Common/missing
  loading: "로딩 중…",
  noSentences: "문장이 없습니다",
  editText: "텍스트 편집",
  save: "저장",
  pleaseFillAllFieldsCorrectly: "모든 필드를 올바르게 입력하세요",
  saved: "저장됨",
  textUpdated: "텍스트가 업데이트되었습니다",
  folderRenamed: "폴더 이름이 변경되었습니다",
  delete: "삭제",
  rename: "이름 변경",
  edit: "편집",
  confirmDeleteFolder: "이 폴더와 내용을 삭제하시겠습니까?",
  confirmDeleteText: "이 텍스트를 삭제하시겠습니까?",
  texts: "텍스트",
  noTextsYet: "이 폴더에는 아직 텍스트가 없습니다",
  failed: "실패함",
  failedOpenEditor: "편집기를 열지 못했습니다",
  tapWordsBelow: "아래의 단어를 누르세요",
};

const tr: Messages = {
  appTitle: "LinguaText",
  folders: "Klasörler",
  yourFolders: "Klasörlerin",
  newFolder: "Yeni Klasör",
  newFolderPlaceholder: "Klasör adı",
  createIn: "Oluşturulacak yer: {place}",
  root: "Kök",
  back: "Geri",
  loadingFolders: "Klasörler yükleniyor…",
  noFoldersYet: "Henüz klasör yok",
  nameLabel: "Adı",
  nameHelper: "1–100 karakter",
  nameExists: "Bu ad zaten mevcut",
  cancel: "İptal",
  create: "Oluştur",
  folderCreated: "Klasör oluşturuldu",
  unauthorized: "Yetkisiz",
  loginWithTelegram: "Telegram ile giriş yap",
  loggingIn: "Giriş yapılıyor…",
  loggedInAs: "Giriş yapan:",
  helloTitle: "Merhaba, Diller Öğrenme Uygulaması",
  environmentTWA: "Ortam: Telegram WebApp ✅",
  andHelloName: "— Merhaba, {name}!",
  errorLoadFolders: "Klasörler yüklenemedi",
  errorCreateFolder: "Klasör oluşturulamadı",
  addText: "Metin Ekle",
  titleLabel: "Başlık",
  uzRawLabel: "Metin",
  enRawLabel: "Metin",
  createText: "Metin Oluştur",
  textCreated: "Metin oluşturuldu",
  prev: "Önceki",
  next: "Sonraki",
  ofTotal: "{i} / {n}",
  buildTitle: "Cümleyi oluştur",
  check: "Kontrol et",
  correct: "Doğru!",
  incorrect: "Yanlış, tekrar deneyin",
  reset: "Sıfırla",
  reveal: "Göster",
  continue: "Devam et",
  correctAnswer: "Doğru cevap:",
  // Common/missing
  loading: "Yükleniyor…",
  noSentences: "Cümle yok",
  editText: "Metni düzenle",
  save: "Kaydet",
  pleaseFillAllFieldsCorrectly: "Lütfen tüm alanları doğru doldurun",
  saved: "Kaydedildi",
  textUpdated: "Metin güncellendi",
  folderRenamed: "Klasör yeniden adlandırıldı",
  delete: "Sil",
  rename: "Yeniden adlandır",
  edit: "Düzenle",
  confirmDeleteFolder: "Bu klasörü ve içeriğini silmek istiyor musunuz?",
  confirmDeleteText: "Bu metni silmek istiyor musunuz?",
  texts: "Metinler",
  noTextsYet: "Bu klasörde henüz metin yok",
  failed: "Başarısız",
  failedOpenEditor: "Düzenleyici açılamadı",
  tapWordsBelow: "Aşağıdaki kelimelere dokunun",
};

const dict: Record<string, Messages> = { uz, en, ru, ko, tr };

export const locales: Array<{ code: string; label: string }> = [
  { code: "uz", label: "O‘zbekcha" },
  { code: "ru", label: "Русский" },
  { code: "en", label: "English" },
  { code: "ko", label: "한국어" },
  { code: "tr", label: "Türkçe" },
];

const saved = (() => {
  try {
    return localStorage.getItem("locale") || undefined;
  } catch {
    return undefined;
  }
})();

let currentLocale = saved && dict[saved] ? saved : "uz";

export function setLocale(locale: string) {
  currentLocale = dict[locale] ? locale : "en";
  try {
    localStorage.setItem("locale", currentLocale);
  } catch {}
  return currentLocale;
}

export function getLocale() {
  return currentLocale;
}

export function ensureInitialLocale(): string {
  // If user has a saved locale, keep it
  if (saved && dict[saved]) return saved;

  // Try Telegram WebApp language code
  const tgLang = (window as any)?.Telegram?.WebApp?.initDataUnsafe?.user
    ?.language_code as string | undefined;

  const browserLang =
    navigator.language || (navigator as any).userLanguage || "en";

  const chosen = pickSupportedLocale(tgLang || browserLang);
  return setLocale(chosen);
}

function pickSupportedLocale(lang: string | undefined): string {
  if (!lang) return "en";
  const l = lang.toLowerCase();
  if (l.startsWith("uz")) return "uz";
  if (l.startsWith("ru")) return "ru";
  if (l.startsWith("en")) return "en";
  if (l.startsWith("ko") || l.startsWith("kr")) return "ko";
  if (l.startsWith("tr")) return "tr";
  return "en";
}

export function t(
  key: keyof Messages,
  vars?: Record<string, string | number>
): string {
  const msg =
    (dict[currentLocale] && dict[currentLocale][key]) ||
    dict.en[key] ||
    String(key);
  if (!vars) return msg;
  return Object.entries(vars).reduce(
    (acc, [k, v]) => acc.replaceAll(`{${k}}`, String(v)),
    msg
  );
}
